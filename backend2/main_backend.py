# main_backend.py
import json
import time
import os
import requests
from io import BytesIO
from pptx import Presentation
from pptx.util import Pt, Inches
from pptx.dml.color import RGBColor
from openai import OpenAI

# === 1. å®šä¹‰æ•°æ®ç»“æ„ä¸ LLM æ¥å£ ===
def get_content_from_llm(topic, use_ai=False):
    # --- 1.1 æ¨¡æ‹Ÿæ¨¡å¼ (Mock) ---
    if not use_ai:
        print("(æµ‹è¯•æ¨¡å¼) ä½¿ç”¨é¢„è®¾æ•°æ®ï¼ŒåŒ…å«ç½‘ç»œå›¾ç‰‡å…³é”®è¯...")
        time.sleep(0.5)
        return {
            "title": f"{topic} æ·±åº¦è§£æ",
            "subtitle": "Generated by AI Generator",
            "pages": [
                {
                    "type": "text",
                    "title": "èƒŒæ™¯ä»‹ç»",
                    "content": ["ä¼ ç»Ÿæ¨¡å¼æ•ˆç‡ä½ä¸‹", "æ•°å­—åŒ–è½¬å‹åŠ¿åœ¨å¿…è¡Œ", "AI èµ‹èƒ½å…¨æµç¨‹"]
                },
                {
                    "type": "image",
                    "title": "æ¦‚å¿µæ¼”ç¤ºå›¾",
                    # è¿™é‡Œä¸å†å†™æ­»æ–‡ä»¶åï¼Œè€Œæ˜¯ç»™ä¸€ä¸ªè‹±æ–‡å…³é”®è¯
                    "image_query": "futuristic data center cyberpunk style", 
                    "caption": "æœªæ¥æ•°æ®ä¸­å¿ƒæ¦‚å¿µå›¾"
                },
                {
                    "type": "table",
                    "title": "æ•°æ®å¯¹æ¯”",
                    "table_data": {
                        "headers": ["æŒ‡æ ‡", "ä¼ ç»Ÿæ–¹å¼", "AI æ–¹å¼"],
                        "rows": [["è€—æ—¶", "5å¤©", "1åˆ†é’Ÿ"], ["æˆæœ¬", "é«˜æ˜‚", "ä½å»‰"]]
                    }
                }
            ]
        }

    # --- 1.2 AI æ¨¡å¼ (è°ƒç”¨ OpenAI) ---
    print(f"ğŸ¤– (AI æ¨¡å¼) æ­£åœ¨è¯·æ±‚ OpenAI æ„æ€ PPT å†…å®¹...")
    
    #  Key
    api_key = "sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" 
    client = OpenAI(api_key=api_key)
    
    # æ ¸å¿ƒ Promptï¼šæ•™ AI å¦‚ä½•è¿”å› JSON
    prompt = f"""
    ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ PPT ç”ŸæˆåŠ©æ‰‹ã€‚è¯·ä¸ºä¸»é¢˜ "{topic}" ç”Ÿæˆ 4-5 é¡µ PPT å†…å®¹ã€‚
    
    è¾“å‡ºå¿…é¡»æ˜¯çº¯ JSON æ ¼å¼ï¼Œä¸è¦åŒ…å« Markdown æ ‡è®°ï¼ˆå¦‚ ```jsonï¼‰ã€‚
    JSON ç»“æ„è¦æ±‚ï¼š
    {{
        "title": "PPTä¸»æ ‡é¢˜",
        "subtitle": "å‰¯æ ‡é¢˜",
        "pages": [
            {{ 
                "type": "text", 
                "title": "é¡µæ ‡é¢˜", 
                "content": ["è¦ç‚¹1", "è¦ç‚¹2", "è¦ç‚¹3"] 
            }},
            {{
                "type": "image",
                "title": "é¡µæ ‡é¢˜",
                "image_query": "è¿™é‡Œå†™ä¸€ä¸ªæè¿°è¯¥é¡µé¢å†…å®¹çš„è‹±æ–‡å…³é”®è¯ï¼Œç”¨äºç”Ÿæˆå›¾ç‰‡ï¼Œä¾‹å¦‚ 'business meeting'",
                "caption": "å›¾ç‰‡ä¸‹æ–¹çš„è¯´æ˜æ–‡å­—"
            }},
            {{
                "type": "table",
                "title": "å¯¹æ¯”åˆ†æ",
                "table_data": {{
                    "headers": ["åˆ—1", "åˆ—2", "åˆ—3"],
                    "rows": [["A1", "B1", "C1"], ["A2", "B2", "C2"]]
                }}
            }}
        ]
    }}
    è¯·ç¡®ä¿è‡³å°‘åŒ…å« 1 é¡µ image ç±»å‹å’Œ 1 é¡µ table ç±»å‹ã€‚
    """
    
    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo", # å¦‚æœä½ æœ‰ gpt-4ï¼Œå»ºè®®æ”¹æˆ gpt-4-turboï¼ŒJSON æ ¼å¼æ›´ç¨³
            messages=[{"role": "user", "content": prompt}],
            temperature=0.7
        )
        content = response.choices[0].message.content
        # æ¸…ç†å¯èƒ½å­˜åœ¨çš„ markdown ç¬¦å·
        content = content.replace("```json", "").replace("```", "")
        return json.loads(content)
    except Exception as e:
        print(f"OpenAI è°ƒç”¨æˆ–è§£æå¤±è´¥: {e}")
        return None


# === 2. å­—ä½“ä¸æ’ç‰ˆ ===
def auto_fit_text(text_frame, content_list, font_name="Microsoft YaHei"):
    text_frame.clear()
    total_chars = sum([len(line) for line in content_list])
    
    if total_chars > 200: font_size = Pt(14)
    elif total_chars > 100: font_size = Pt(18)
    else: font_size = Pt(24)

    for line in content_list:
        p = text_frame.add_paragraph()
        p.text = line
        p.font.size = font_size
        p.font.name = font_name
        p.space_after = Pt(10)


# === 3. ä¸‹è½½ç½‘ç»œå›¾ç‰‡ ===
def get_image_stream(query):
    """
    å°è¯•ä» AI æ¥å£ä¸‹è½½å›¾ç‰‡ã€‚å¦‚æœå¤±è´¥ï¼Œè‡ªåŠ¨é™çº§ä½¿ç”¨éšæœºé£æ™¯å›¾ã€‚
    """
    # 1. å‡†å¤‡è¯·æ±‚å¤´ (å‡è£…è‡ªå·±æ˜¯æµè§ˆå™¨ï¼Œé˜²æ­¢è¢«æ‹¦æˆª)
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36"
    }

    # 2. å®šä¹‰å›¾ç‰‡æº
    safe_query = query.replace(" ", "%20")
    # é¦–é€‰ï¼šAI ç”Ÿæˆæº
    url_primary = f"https://image.pollinations.ai/prompt/{safe_query}?width=1280&height=720&nologo=true"
    # å¤‡é€‰ï¼šéšæœºé£æ™¯æº (å¦‚æœä¸é€šï¼Œå°±ç”¨è¿™ä¸ªå…œåº•)
    url_backup = "https://picsum.photos/1280/720"

    print(f"   â¬‡ï¸ æ­£åœ¨ä¸‹è½½å›¾ç‰‡: {query} ...")
    
    # 3. å°è¯•ä¸‹è½½ (ä¸»æº)
    try:
        response = requests.get(url_primary, headers=headers, timeout=10)
        if response.status_code == 200:
            return BytesIO(response.content)
        else:
            print(f"   âš ï¸ AI å›¾ç‰‡æºå¤±è´¥ (çŠ¶æ€ç  {response.status_code})ï¼Œå°è¯•å¤‡ç”¨æº...")
    except Exception as e:
        print(f"   âš ï¸ AI å›¾ç‰‡æºè¿æ¥é”™è¯¯: {e}")

    # 4. å°è¯•ä¸‹è½½ (å¤‡ç”¨æº)
    try:
        print(f"   ğŸ”„ æ­£åœ¨åˆ‡æ¢åˆ°å¤‡ç”¨å›¾ç‰‡æº (Picsum)...")
        response = requests.get(url_backup, headers=headers, timeout=10)
        if response.status_code == 200:
            return BytesIO(response.content)
    except Exception as e:
        print(f"   âŒ å¤‡ç”¨æºä¹Ÿå¤±è´¥äº†: {e}")

    return None


# === 4. é¡µé¢ç”Ÿæˆé€»è¾‘ ===
def create_table_slide(slide, data, font_name):
    left = Inches(1); top = Inches(2); width = Inches(8); height = Inches(4)
    headers = data.get("headers", [])
    rows = data.get("rows", [])
    if not headers: return

    shape = slide.shapes.add_table(len(rows)+1, len(headers), left, top, width, height)
    table = shape.table

    # è¡¨å¤´
    for i, h in enumerate(headers):
        cell = table.cell(0, i)
        cell.text = str(h)
        cell.fill.solid()
        cell.fill.fore_color.rgb = RGBColor(0, 112, 192)
        for p in cell.text_frame.paragraphs:
            p.font.name = font_name
            p.font.bold = True
            p.font.color.rgb = RGBColor(255, 255, 255)

    # å†…å®¹
    for r_idx, row in enumerate(rows):
        for c_idx, val in enumerate(row):
            cell = table.cell(r_idx+1, c_idx)
            cell.text = str(val)
            for p in cell.text_frame.paragraphs:
                p.font.name = font_name
                p.font.size = Pt(14)

def create_image_slide(slide, image_query, caption, font_name):
    # 1. ä¸‹è½½å›¾ç‰‡æµ
    image_stream = get_image_stream(image_query)
    
    if not image_stream:
        # å¦‚æœä¸‹è½½å¤±è´¥å°±æ”¾ä¸€ä¸ªæ–‡æœ¬æ¡†æç¤º
        txBox = slide.shapes.add_textbox(Inches(3), Inches(3), Inches(4), Inches(1))
        txBox.text_frame.text = f"[ å›¾ç‰‡ä¸‹è½½å¤±è´¥: {image_query} ]"
        return

    # 2. æ’å…¥å›¾ç‰‡
    left = Inches(1.5); top = Inches(2); height = Inches(4.5)
    slide.shapes.add_picture(image_stream, left, top, height=height)

    # 3. æ·»åŠ è¯´æ˜
    if caption:
        txBox = slide.shapes.add_textbox(Inches(1.5), Inches(6.6), Inches(7), Inches(1))
        p = txBox.text_frame.add_paragraph()
        p.text = caption
        p.font.size = Pt(12)
        p.font.italic = True
        p.font.name = font_name


# === 5. ä¸»å…¥å£ ===
def generate_ppt_file(topic, output_filename="final_output.pptx", template_path="template.pptx", font_name="Microsoft YaHei", use_ai=False):
    
    data = get_content_from_llm(topic, use_ai=use_ai)
    if not data: return None

    if os.path.exists(template_path):
        prs = Presentation(template_path)
    else:
        prs = Presentation()

    # å°é¢
    slide = prs.slides.add_slide(prs.slide_layouts[0])
    if slide.shapes.title: 
        slide.shapes.title.text = data.get("title", "")
        for p in slide.shapes.title.text_frame.paragraphs: p.font.name = font_name
    
    if len(slide.placeholders) > 1:
        try: slide.placeholders[1].text = data.get("subtitle", "")
        except: pass

    # å†…å®¹é¡µ
    layout_idx = 1 if len(prs.slide_layouts) > 1 else 0
    
    for page in data.get("pages", []):
        slide = prs.slides.add_slide(prs.slide_layouts[layout_idx])
        
        # æ ‡é¢˜
        if slide.shapes.title:
            slide.shapes.title.text = page.get("title", "")
            for p in slide.shapes.title.text_frame.paragraphs: p.font.name = font_name
        
        p_type = page.get("type", "text")
        
        if p_type == "text":
            if len(slide.placeholders) > 1:
                auto_fit_text(slide.placeholders[1].text_frame, page.get("content", []), font_name)
        
        elif p_type == "table":
            create_table_slide(slide, page.get("table_data", {}), font_name)
            
        elif p_type == "image":
            # ä¼ å…¥ image_query è€Œä¸æ˜¯ path
            query = page.get("image_query", "technology")
            caption = page.get("caption", "")
            create_image_slide(slide, query, caption, font_name)

    try:
        prs.save(output_filename)
        print(f"PPTç”Ÿæˆå®Œæ¯•: {output_filename}")
        return output_filename
    except Exception as e:
        print(f"ä¿å­˜å¼‚å¸¸: {e}")
        return None